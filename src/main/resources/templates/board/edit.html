<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 수정</title>
    <link th:href="@{/css/bootstrap.min.css}"
          href="../../css/bootstrap.min.css" rel="stylesheet">
    <script src="../../jquery/jquery-3.7.0.min.js"></script>
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.css" rel="stylesheet">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.js"></script>

    <!-- include summernote css/js-->
    <link href="http://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.8/summernote.css" rel="stylesheet">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.8/summernote.js"></script>
    <script src="../../js/summernote/summernote-ko-KR.js"></script>
</head>
<style>
    .container {
        max-width: 560px;
    }

    .field-error {
        border-color: #dc3545;
        color: #dc3545;
    }

    input {
        margin: 4px;
    }

    @font-face {
        font-family: 'SUITE-Regular';
        src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2304-2@1.0/SUITE-Regular.woff2') format('woff2');
        font-weight: 400;
        font-style: normal;
    }

    footer {
        /* footer를 aside위에 올리기 위해 사용(부유객체) */
        position: absolute;
        height: 60px;
        width: 100%;
        padding: 0 25px;
        line-height: 60px;
        color: #94a9ff;
        border-top: 1px solid #94a9ff;
        background-color: #94a9ff;
        margin-top: 100px;
    }

</style>


<script>
    $(document).ready(function () {
        $('#summernote').summernote({
            placeholder: '내용',
            minHeight: 200,
            maxHeight: null,
            focus: true,
            lang: 'ko-KR',
            height: 300,                 // 에디터 높이
            lang: "ko-KR",					// 한글 설정
           callbacks: {
                onImageUpload: function (files) {
                    // 파일 업로드(다중업로드를 위해 반복문 사용)
                    for (var i = files.length - 1; i >= 0; i--) {
                        uploadSummernoteImageFile(files[i], this);
                    }
                }
            }
        })
    });

    /**
     * 이미지 파일 업로드
     */
    function uploadSummernoteImageFile(file, el) {
        data = new FormData();
        data.append("file", file);
        $.ajax({
            data: data,
            type: "POST",
            url: "/uploadSummernoteImageFile",
            contentType: false,
            enctype: 'multipart/form-data',
            processData: false,
            success: function (data) {
                $(el).summernote('insertImage', data.url);
            }
        });
    }

    function deleteFile(num) {
        $('#file'+num).val('');
        $('#edtText'+num).val('');
    }

    function editFile(num) {
        var obj = $('#file'+num).val().split("\\");
        $('#edtText'+num).val(obj[obj.length-1]);
    }

    // 댓글 길이 카운팅
    function countingLength(contents) {
        if (contents.value.length > 300) {
            alert('댓글을 300자 이하로 입력해 주세요.');
            contents.value = contents.value.substring(0, 300);
            contents.focus();
        }
        document.getElementById('counter').innerText = contents.value.length + '/300자';
    }

    window.onload = () => {
        findAllComment();
    }


    // 전체 댓글 조회
    function findAllComment() {

        const postId = [[ ${result.id} ]];

        $.ajax({
            url : `/board/${id}/comments`,
            type : 'get',
            dataType : 'json',
            async : false,
            success : function (result) {

                // 1. 조회된 데이터가 없는 경우
                if ( !result.length ) {
                    document.querySelector('.cm_list').innerHTML = '<div class="cm_none"><p>등록된 댓글이 없습니다.</p></div>';
                    return false;
                }

                // 2. 렌더링 할 HTML을 저장할 변수
                let commentHtml = '';

                // 3. 댓글 HTML 추가
                result.forEach(row => {
                    commentHtml += `
                                <div>
                                    <span class="writer_img"><img src="/images/default_profile.png" width="30" height="30" alt="기본 프로필 이미지"/></span>
                                    <p class="writer">
                                        <em>${row.crtId}</em>
                                        <span class="date">${dayjs(row.createdDate).format('YYYY-MM-DD HH:mm')}</span>
                                    </p>
                                    <div class="cont"><div class="txt_con">${row.contents}</div></div>
                                    <p class="func_btns">
                                        <button type="button" onclick="openCommentUpdatePopup(${row.id});" class="btns"><span class="icons icon_modify">수정</span></button>
                                        <button type="button" class="btns"><span class="icons icon_del">삭제</span></button>
                                    </p>
                                </div>
                            `;
                })

                // 4. class가 "cm_list"인 요소를 찾아 HTML을 렌더링
                document.querySelector('.cm_list').innerHTML = commentHtml;
            },
            error : function (request, status, error) {
                console.log(error)
            }
        })
    }

    // 댓글 저장
    function saveComment() {

        const contents = document.getElementById('contents');
        isValid(contents, '댓글');

        const postId = [[ ${result.id} ]];
        const params = {
            postId : postId,
            contents : contents.value,
            writer : '홍길동'
        }

        $.ajax({
            url : `/board/${id}/comments`,
            type : 'post',
            //contentType : 'application/json; charset=utf-8',
            //dataType : 'json',
            //data : JSON.stringify(params),
            dataType : 'text',
            data : params,
            async : false,
            success : function (result) {
                alert('저장되었습니다.');
                contents.value = '';
                document.getElementById('counter').innerText = '0/300자';
                findAllComment();
            },
            error : function (request, status, error) {
                console.log(error)
            }
        })
    }

</script>
<body>
<h2 style="text-align: center;">글 수정</h2><br><br><br>

<div class="container" style="margin: auto;">
    <div>
    <form id="updateForm" method="post" th:action th:object="${item}" enctype="multipart/form-data">
        <input type="hidden" th:field="*{id}">
        <label for="name">제목</label>
        <input th:errorclass="field-error" id="name" type="text" name="name" th:field="*{name}" style="width: 20%;"
               placeholder="제목"/><br>
        <div class="field-error" th:errors="*{name}">제목 오류</div>
        <label for="writer">작성자</label>
        <input th:errorclass="field-error" id="writer" type="text" name="writer" th:field="*{writer}"
               style="width: 40%;" placeholder="작성자"/>
        <div class="field-error" th:errors="*{writer}">작성자 오류</div>
        <br>
        <label for="is_top">상단 여부</label>
        <input type="checkbox" id="is_top" name="is_top" th:field="*{is_top}" th:checked="*{is_top eq 'Y'} ? 'checked':null" class="form-check-input">
        <input type="hidden" name="_is_top" value="N" th:attr="value=${is_top}"/>
        <br><br>
        <textarea id="summernote" name="content" th:utext="*{content}"></textarea>
        <div style="width: 100%;" th:each="file, fileStat : ${fileList}">
            <input name="storeFileName" type="text" th:value="${file.storeFileName}" hidden="true">
            <input name="fileName" style="display: inline;" type="text" th:id="edtText+(${fileStat.index}+1)" th:value="${file.uploadFileName}" readonly>
            <input style="display: inline;" type="file" name="file" th:id="file+(${fileStat.index}+1)" th:onchange="editFile([[${fileStat.index}]]+1)"> <a href='#' th:onclick="deleteFile([[${fileStat.index}]]+1);">[X]</a>
        </div>
        <th:block th:if="${fileList != null and fileList.size() < 2}">
            <div th:each="num : ${#numbers.sequence(fileList.size()+1,2)}">
                <input name="storeFileName" type="text" hidden="true">
                <input name="fileName" style="display: inline;" type="text" th:id="edtText+(${num})" readonly>
                <input style="display: inline" type="file" name="file" th:id="'file' + ${num}" th:onchange="editFile([[${num}]])"> <a href='#' th:onclick="deleteFile('#file[[${num}]]')">[X]</a>
            </div>
        </th:block>
        <th:block th:if="${fileList == null}">
            <div th:each="num : ${#numbers.sequence(1,2)}">
                <input name="storeFileName" type="text" hidden="true">
                <input name="fileName" style="display: inline;" type="text" th:id="edtText+(${num})" readonly>
                <input style="display: inline" type="file" name="file" th:id="'file' + ${num}" th:onchange="editFile([[${num}]])"> <a href='#' th:onclick="deleteFile('#file[[${num}]]')">[X]</a>
            </div>
        </th:block>
        <div style="float: right">
            <button th:onclick="|location.href='@{/board/edit/{itemId}(itemId=${item.id})}'|" class="btn btn-primary" type="submit" style="margin-top: 3px;margin-right: 2px">수정</button>
            <button th:onclick="|location.href='@{/board/delete/{itemId}(itemId=${item.id})}'|" class="btn btn-secondary" type="button" style="margin-top: 3px;">삭제</button>
        </div>
    </form>
    </div>
    <div style="margin-top: 50px;" class="cm_write">
        <fieldset>
            <legend class="skipinfo">댓글 입력</legend>
            <div class="cm_input">
                <p><textarea id="contents" name="contents" onkeyup="countingLength(this);" cols="90" rows="4" placeholder="댓글을 입력해 주세요."></textarea></p>
                <span><button type="button" class="btns" onclick="saveComment();">등 록</button> <i id="counter">0/300자</i></span>
            </div>
        </fieldset>
    </div>
</div>

<footer></footer>
</body>
</html>
